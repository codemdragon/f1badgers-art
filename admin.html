<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1Badgers | Admin Panel</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #FFF0F5;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Fredoka', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .pink-gradient {
            background: linear-gradient(135deg, #FF69B4, #FF1493);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #DB2777;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- GitHub API Utilities ---
        const GITHUB_CONFIG = {
            owner: 'codemdragon',
            repo: 'f1badgers-art',
            path: 'db.json'
        };

        const updateDbOnGithub = async (token, newData, sha) => {
            const jsonString = JSON.stringify(newData, null, 2);
            // Handle UTF-8 for btoa
            const content = btoa(unescape(encodeURIComponent(jsonString)));
            const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Update db.json via Admin Panel`,
                    content: content,
                    sha: sha
                })
            });
            return response.json();
        };

        // --- UI Components ---
        const Card = ({ children, title, subtitle, info }) => (
            <div className="bg-white rounded-3xl p-6 shadow-xl border-2 border-pink-100 relative overflow-hidden">
                {info && <div className="absolute top-4 right-4 text-pink-400 font-bold">{info}</div>}
                <h3 className="text-2xl font-bold text-gray-800 mb-1">{title}</h3>
                <p className="text-gray-500 mb-6 font-medium">{subtitle}</p>
                {children}
            </div>
        );

        const Input = ({ label, ...props }) => (
            <div className="mb-4">
                <label className="block text-sm font-bold text-gray-700 mb-1 ml-1">{label}</label>
                <input {...props} className="w-full px-4 py-3 rounded-2xl border-2 border-gray-100 focus:border-pink-300 focus:outline-none transition-colors" />
            </div>
        );

        const Button = ({ children, variant = 'primary', ...props }) => {
            const styles = {
                primary: 'bg-pink-500 text-white shadow-[0_4px_0_#9d174d] hover:bg-pink-600',
                secondary: 'bg-yellow-400 text-black shadow-[0_4px_0_#ca8a04] hover:bg-yellow-500',
                danger: 'bg-red-500 text-white shadow-[0_4px_0_#991b1b] hover:bg-red-600',
                outline: 'bg-white text-gray-600 border-2 border-gray-200 hover:border-pink-300'
            };
            return (
                <button {...props} className={`${styles[variant]} px-6 py-2.5 rounded-xl font-bold active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2`}>
                    {children}
                </button>
            );
        };

        // --- App Component ---
        const App = () => {
            const [token, setToken] = useState(sessionStorage.getItem('gh_token') || '');
            const [isAuth, setIsAuth] = useState(!!sessionStorage.getItem('gh_token'));
            const [db, setDb] = useState(null);
            const [sha, setSha] = useState('');
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('art');
            const [status, setStatus] = useState({ type: '', message: '' });

            useEffect(() => {
                if (isAuth) fetchDb();
            }, [isAuth]);

            const fetchDb = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`);
                    const data = await res.json();
                    setSha(data.sha);
                    // Handle UTF-8 for atob
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(data.content.replace(/\n/g, '')))));
                    setDb(decoded);
                } catch (err) {
                    showStatus('error', 'Failed to fetch database');
                }
                setLoading(false);
            };

            const showStatus = (type, message) => {
                setStatus({ type, message });
                setTimeout(() => setStatus({ type: '', message: '' }), 3000);
            };

            const handleLogin = () => {
                if (token.length > 20) {
                    sessionStorage.setItem('gh_token', token);
                    setIsAuth(true);
                } else {
                    alert('Please enter a valid token');
                }
            };

            const handleLogout = () => {
                sessionStorage.removeItem('gh_token');
                setIsAuth(false);
                setToken('');
            };

            const saveChanges = async (newDb) => {
                setLoading(true);
                try {
                    const res = await updateDbOnGithub(token, newDb, sha);
                    if (res.content) {
                        setSha(res.content.sha);
                        setDb(newDb);
                        showStatus('success', 'Changes saved to GitHub!');
                    } else {
                        throw new Error('Save failed');
                    }
                } catch (err) {
                    showStatus('error', 'Failed to save changes');
                    fetchDb(); // Refresh to get correct SHA
                }
                setLoading(false);
            };

            // --- Handlers ---
            const addArt = () => {
                const newId = Math.max(0, ...db.artworks.map(a => a.id)) + 1;
                const newArt = {
                    id: newId,
                    title: 'New Fun Creation',
                    category: db.categories[1] || 'Digital Art',
                    theme: db.categories[1] || 'Cool Stuff',
                    src: '',
                    likes: 0,
                    stickers: [],
                    dateUploaded: new Date().toISOString().split('T')[0]
                };
                saveChanges({ ...db, artworks: [newArt, ...db.artworks] });
            };

            const updateArt = (id, field, value) => {
                const newArtworks = db.artworks.map(a => a.id === id ? { ...a, [field]: value } : a);
                setDb({ ...db, artworks: newArtworks });
            };

            const deleteArt = (id) => {
                if (confirm('Delete this masterpiece?')) {
                    saveChanges({ ...db, artworks: db.artworks.filter(a => a.id !== id) });
                }
            };

            const addCategory = () => {
                const name = prompt('New Category Name:');
                if (name && !db.categories.includes(name)) {
                    saveChanges({ ...db, categories: [...db.categories, name] });
                }
            };

            const removeCategory = (name) => {
                if (name === 'All') return;
                saveChanges({ ...db, categories: db.categories.filter(c => c !== name) });
            };

            const handleFileUpload = (e, callback) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => callback(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const addSticker = (base64) => {
                saveChanges({ ...db, stickers: [...db.stickers, base64] });
            };

            const replaceSticker = (idx, base64) => {
                const newStickers = [...db.stickers];
                newStickers[idx] = base64;
                saveChanges({ ...db, stickers: newStickers });
            };

            const removeSticker = (idx) => {
                saveChanges({ ...db, stickers: db.stickers.filter((_, i) => i !== idx) });
            };

            if (!isAuth) return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="max-w-md w-full glass p-10 rounded-[3rem] shadow-2xl border-4 border-white text-center">
                        <div className="bg-pink-500 text-white w-20 h-20 rounded-full flex items-center justify-center font-bold text-3xl mx-auto mb-6 shadow-xl border-4 border-pink-200">F1</div>
                        <h1 className="text-4xl font-bold text-gray-800 mb-2">Admin Portal</h1>
                        <p className="text-gray-500 mb-8 font-medium">Hello F1! Please enter your key to manage your art world.</p>
                        <Input type="password" placeholder="GitHub Token..." value={token} onChange={e => setToken(e.target.value)} />
                        <Button onClick={handleLogin} variant="primary" className="w-full py-4 text-xl mt-4">Unlock ‚ú®</Button>
                        <p className="mt-8 text-xs text-gray-400">Your key is safe and never stored anywhere except your browser.</p>
                    </div>
                </div>
            );

            if (!db) return <div className="min-h-screen flex items-center justify-center text-pink-600 font-bold text-2xl animate-pulse">Loading Art World... üé®</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Top Bar */}
                    <div className="bg-white/80 backdrop-blur-md border-b-2 border-pink-100 sticky top-0 z-50">
                        <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                {db.siteSettings.logo ? <img src={db.siteSettings.logo} className="w-10 h-10 rounded-full border-2 border-pink-200 shadow-md object-cover" /> : <div className="bg-pink-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">F1</div>}
                                <h1 className="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                            </div>
                            <div className="flex gap-4">
                                <Button variant="outline" onClick={handleLogout}>Lock üîí</Button>
                            </div>
                        </div>
                    </div>

                    {/* Status Message */}
                    {status.message && (
                        <div className={`fixed top-24 right-6 px-6 py-3 rounded-2xl shadow-xl z-50 animate-bounce text-white font-bold ${status.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                            {status.message}
                        </div>
                    )}

                    {/* Main Content */}
                    <main className="container mx-auto px-6 py-10 flex-grow">
                        <div className="flex flex-col lg:flex-row gap-10">

                            {/* Sidebar Tabs */}
                            <aside className="lg:w-64 space-y-4">
                                <button onClick={() => setActiveTab('art')} className={`w-full text-left px-6 py-4 rounded-2xl font-bold transition-all ${activeTab === 'art' ? 'bg-pink-500 text-white shadow-lg translate-x-2' : 'bg-white text-gray-600 hover:bg-pink-50'}`}>üé® My Creations</button>
                                <button onClick={() => setActiveTab('cats')} className={`w-full text-left px-6 py-4 rounded-2xl font-bold transition-all ${activeTab === 'cats' ? 'bg-pink-500 text-white shadow-lg translate-x-2' : 'bg-white text-gray-600 hover:bg-pink-50'}`}>üè∑Ô∏è Categories</button>
                                <button onClick={() => setActiveTab('stickers')} className={`w-full text-left px-6 py-4 rounded-2xl font-bold transition-all ${activeTab === 'stickers' ? 'bg-pink-500 text-white shadow-lg translate-x-2' : 'bg-white text-gray-600 hover:bg-pink-50'}`}>‚ú® Stickers & Logo</button>
                                <div className="pt-8 opacity-50 text-center">
                                    <p className="text-sm font-bold text-pink-400">F1Badgers v2.0</p>
                                </div>
                            </aside>

                            {/* Admin View */}
                            <section className="flex-grow">
                                {activeTab === 'art' && (
                                    <Card title="Creations Manager" subtitle="Create, edit and remove your amazing work" info={`${db.artworks.length} pieces`}>
                                        <div className="flex justify-end mb-8">
                                            <Button onClick={addArt} variant="secondary">Add New Artwork +</Button>
                                        </div>
                                        <div className="space-y-6">
                                            {db.artworks.map(art => (
                                                <div key={art.id} className="bg-gray-50 rounded-[2rem] p-6 border-2 border-transparent hover:border-pink-200 transition-all flex flex-col md:flex-row gap-6 group">
                                                    <div className="w-full md:w-48 h-48 rounded-2xl overflow-hidden bg-white border-2 border-gray-100 flex-shrink-0 relative">
                                                        {art.src ? <img src={art.src} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-400 font-bold uppercase p-4 text-center">Add Link or Upload</div>}
                                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleFileUpload(e, (b) => updateArt(art.id, 'src', b))} />
                                                    </div>
                                                    <div className="flex-grow space-y-4">
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            <Input label="Title" value={art.title} onChange={e => updateArt(art.id, 'title', e.target.value)} />
                                                            <div className="mb-4">
                                                                <label className="block text-sm font-bold text-gray-700 mb-1 ml-1">Category</label>
                                                                <select value={art.theme} onChange={e => updateArt(art.id, 'theme', e.target.value)} className="w-full px-4 py-3 rounded-2xl border-2 border-gray-100 focus:border-pink-300 focus:outline-none bg-white">
                                                                    {db.categories.map(c => <option key={c} value={c}>{c}</option>)}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <Input label="Image Link (or upload above)" value={art.src} onChange={e => updateArt(art.id, 'src', e.target.value)} />
                                                        <div className="flex justify-between items-center">
                                                            <div className="flex gap-4">
                                                                <Button onClick={() => saveChanges(db)} variant="outline">Save Checkpoint</Button>
                                                            </div>
                                                            <Button onClick={() => deleteArt(art.id)} variant="danger">Remove üóëÔ∏è</Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="mt-10 pt-10 border-t-2 border-pink-50 text-center">
                                            <Button onClick={() => saveChanges(db)} variant="primary" className="mx-auto px-12 py-4 text-xl">Confirm All Changes üöÄ</Button>
                                        </div>
                                    </Card>
                                )}

                                {activeTab === 'cats' && (
                                    <Card title="Category Manager" subtitle="Manage the filter buttons on your gallery">
                                        <div className="flex flex-wrap gap-4 mb-8">
                                            {db.categories.map(cat => (
                                                <div key={cat} className="bg-pink-100 text-pink-700 font-bold px-6 py-3 rounded-2xl flex items-center gap-3 border-2 border-pink-200">
                                                    {cat}
                                                    {cat !== 'All' && <button onClick={() => removeCategory(cat)} className="text-pink-400 hover:text-pink-600">√ó</button>}
                                                </div>
                                            ))}
                                            <button onClick={addCategory} className="border-2 border-dashed border-pink-300 text-pink-500 font-bold px-6 py-3 rounded-2xl hover:bg-pink-50 transition-colors">+ Add Category</button>
                                        </div>
                                        <div className="p-4 bg-yellow-50 rounded-2xl border-2 border-yellow-200 text-yellow-800 font-medium">
                                            üí° Note: Categories are used for the filter buttons at the top of your website.
                                        </div>
                                    </Card>
                                )}

                                {activeTab === 'stickers' && (
                                    <div className="space-y-10">
                                        <Card title="Sticker Manager" subtitle="Create your own custom stickers for drawings">
                                            <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-6 mb-8">
                                                {db.stickers.map((s, i) => (
                                                    <div key={i} className="aspect-square bg-gray-50 rounded-2xl border-2 border-gray-100 flex flex-col items-center justify-center p-2 relative group overflow-hidden">
                                                        {s.startsWith('data:image') ? <img src={s} className="max-w-full max-h-[80%] object-contain" /> : <span className="text-4xl">{s}</span>}

                                                        {/* Actions Overlay */}
                                                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                                                            <div className="relative">
                                                                <Button variant="secondary" className="px-2 py-1 text-[10px] shadow-none">Replace</Button>
                                                                <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleFileUpload(e, (b) => replaceSticker(i, b))} />
                                                            </div>
                                                            <button onClick={() => removeSticker(i)} className="text-white bg-red-500 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-lg hover:bg-red-600">√ó</button>
                                                        </div>
                                                    </div>
                                                ))}
                                                <div className="aspect-square border-2 border-dashed border-pink-300 rounded-2xl flex items-center justify-center relative hover:bg-pink-50 transition-colors">
                                                    <span className="text-pink-500 font-bold text-center p-2">Click to Upload</span>
                                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleFileUpload(e, addSticker)} />
                                                </div>
                                            </div>
                                        </Card>

                                        <Card title="Site Identity" subtitle="Update your website logo and title">
                                            <div className="flex flex-col md:flex-row gap-8">
                                                <div className="w-32 h-32 rounded-full border-4 border-white shadow-xl bg-pink-500 flex items-center justify-center overflow-hidden relative group">
                                                    {db.siteSettings.logo ? <img src={db.siteSettings.logo} className="w-full h-full object-cover" /> : <span className="text-white text-3xl font-bold">F1</span>}
                                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white text-xs font-bold text-center p-2">Change Logo</div>
                                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => handleFileUpload(e, (b) => setDb({ ...db, siteSettings: { ...db.siteSettings, logo: b } }))} />
                                                </div>
                                                <div className="flex-grow">
                                                    <Input label="Website Title" value={db.siteSettings.title} onChange={e => setDb({ ...db, siteSettings: { ...db.siteSettings, title: e.target.value } })} />
                                                    <Button onClick={() => saveChanges(db)} variant="primary">Save Identity</Button>
                                                </div>
                                            </div>
                                        </Card>
                                    </div>
                                )}
                            </section>
                        </div>
                    </main >

                    {loading && (
                        <div className="fixed inset-0 bg-white/60 backdrop-blur-sm z-[100] flex flex-col items-center justify-center">
                            <div className="w-16 h-16 border-4 border-pink-100 border-t-pink-500 rounded-full animate-spin mb-4"></div>
                            <p className="text-pink-600 font-bold text-xl">UPDATING GALAXY... üåå</p>
                        </div>
                    )}
                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
